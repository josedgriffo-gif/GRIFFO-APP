<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GRIFFO - Diagn√≥stico API</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:monospace;background:#111;color:#0f0;padding:20px;font-size:14px}
h1{color:#0ff;margin-bottom:20px}
.test{background:#1a1a1a;border:1px solid #333;border-radius:8px;padding:16px;margin-bottom:12px}
.test h3{color:#ff0;margin-bottom:8px}
.ok{color:#0f0}.fail{color:#f00}.warn{color:#ff0}
.num{color:#0ff;font-weight:bold}
pre{white-space:pre-wrap;word-break:break-all;font-size:12px}
button{background:#0f0;color:#000;border:none;padding:12px 24px;font-size:16px;font-weight:bold;cursor:pointer;border-radius:6px;font-family:monospace}
button:hover{background:#0a0}
button:disabled{background:#555;color:#888}
input{background:#222;color:#0f0;border:1px solid #555;padding:10px;font-size:16px;font-family:monospace;border-radius:6px;width:200px}
.controls{display:flex;gap:10px;align-items:center;margin-bottom:20px;flex-wrap:wrap}
table{width:100%;border-collapse:collapse;margin-top:8px}
td,th{padding:4px 8px;border:1px solid #333;text-align:left;font-size:12px}
th{background:#222;color:#ff0}
</style>
</head>
<body>
<h1>GRIFFO APP - DIAGNOSTICO API</h1>
<div class="controls">
<button id="btnRun" onclick="run()">EJECUTAR DIAGNOSTICO</button>
<input id="codeInput" placeholder="Codigo (ej: 253-32)"/>
<button id="btnCode" onclick="code()">BUSCAR CODIGO</button>
</div>
<div id="out"><div class="test"><h3>Esperando...</h3><p>Presiona EJECUTAR DIAGNOSTICO para comenzar.</p></div></div>
<script>
async function run(){
var b=document.getElementById('btnRun');b.disabled=true;b.textContent='EJECUTANDO...';
document.getElementById('out').innerHTML='<div class="test"><h3>Conectando con SpecParts API...</h3><p>Cargando productos GRIFFO (10-15 seg)...</p></div>';
try{var r=await fetch('/api/diagnostic');var d=await r.json();show(d);}
catch(e){document.getElementById('out').innerHTML='<div class="test"><h3 class="fail">ERROR</h3><pre>'+e.message+'</pre></div>';}
b.disabled=false;b.textContent='EJECUTAR DIAGNOSTICO';}

async function code(){
var c=document.getElementById('codeInput').value.trim();if(!c){alert('Ingresa un codigo');return;}
var b=document.getElementById('btnCode');b.disabled=true;b.textContent='BUSCANDO...';
try{var r=await fetch('/api/diagnostic?code='+encodeURIComponent(c));var d=await r.json();show(d);}
catch(e){document.getElementById('out').innerHTML='<div class="test"><h3 class="fail">ERROR</h3><pre>'+e.message+'</pre></div>';}
b.disabled=false;b.textContent='BUSCAR CODIGO';}

function show(data){
var h='',t=data.tests||{};
if(t.credentials){h+='<div class="test"><h3>TEST 1: CREDENCIALES</h3>';
h+='<p>client_id: <span class="num">'+t.credentials.client_id_first_5+t.credentials.client_id_last_5+'</span></p>';
h+='<p>secret: <span class="num">'+t.credentials.secret_first_5+t.credentials.secret_last_5+'</span></p>';
h+='<p style="color:#888">Verificar: client_id empieza con 7vb0Q, secret empieza con gQMbS</p></div>';}
if(t.auth){var ok=t.auth.status==='OK';
h+='<div class="test"><h3>'+(ok?'OK':'ERROR')+' TEST 2: AUTENTICACION</h3>';
h+='<p class="'+(ok?'ok':'fail')+'">'+t.auth.status+'</p>';
if(t.auth.token_first_10)h+='<p>Token: '+t.auth.token_first_10+'</p>';
if(t.auth.httpCode)h+='<p class="fail">HTTP '+t.auth.httpCode+'</p>';
h+='</div>';}
if(t.products){var pok=t.products.total>100;
h+='<div class="test"><h3>'+(pok?'OK':'ERROR')+' TEST 3: PRODUCTOS GRIFFO</h3>';
h+='<p>Total: <span class="num">'+t.products.total+'</span> '+(pok?'CORRECTO':'INCORRECTO')+'</p>';
h+='<p>Con vehiculos: <span class="num">'+t.products.with_vehicles+'</span></p>';
h+='<p>Sin vehiculos: <span class="num">'+t.products.without_vehicles+'</span></p>';
h+='<p>Con imagenes: <span class="num">'+t.products.with_pictures+'</span></p>';
h+='<p>Con links: <span class="num">'+t.products.with_links+'</span></p>';
if(t.products.categories){h+='<h4 style="color:#ff0;margin-top:12px">Categorias:</h4><table><tr><th>Categoria</th><th>Cant</th></tr>';
Object.entries(t.products.categories).sort(function(a,b){return b[1]-a[1]}).forEach(function(e){h+='<tr><td>'+e[0]+'</td><td class="num">'+e[1]+'</td></tr>';});h+='</table>';}
if(t.products.product_types){h+='<h4 style="color:#ff0;margin-top:12px">Tipos:</h4><table><tr><th>Tipo</th><th>Cant</th></tr>';
Object.entries(t.products.product_types).sort(function(a,b){return b[1]-a[1]}).forEach(function(e){h+='<tr><td>'+e[0]+'</td><td class="num">'+e[1]+'</td></tr>';});h+='</table>';}
if(t.products.sample_products){h+='<h4 style="color:#ff0;margin-top:12px">Muestra:</h4><table><tr><th>Codigo</th><th>Desc</th><th>Cat</th><th>Vehic</th><th>Fotos</th></tr>';
t.products.sample_products.forEach(function(p){h+='<tr><td class="num">'+p.code+'</td><td>'+(p.description||'-')+'</td><td>'+(p.category||'-')+'</td><td class="num">'+p.vehicles_count+'</td><td class="num">'+p.pictures_count+'</td></tr>';});h+='</table>';}
h+='</div>';}
if(t.code_search){h+='<div class="test"><h3>TEST 4: BUSQUEDA CODIGO "'+t.code_search.searched+'"</h3>';
h+='<p>Resultados: <span class="num">'+t.code_search.found+'</span></p>';
if(t.code_search.matches)t.code_search.matches.forEach(function(m){
h+='<div style="border-top:1px solid #333;padding-top:8px;margin-top:8px">';
h+='<p><strong class="num">'+m.code+'</strong> - '+(m.description||'')+'</p>';
h+='<p>Producto: '+(m.product||'-')+' | Categoria: '+(m.category||'-')+'</p>';
h+='<p>Vehiculos: <span class="num">'+m.vehicles_count+'</span></p>';
if(m.vehicles_sample&&m.vehicles_sample.length>0)h+='<p style="color:#888">Ej: '+m.vehicles_sample.join(', ')+'</p>';
if(m.pictures&&m.pictures.length>0){h+='<p>';m.pictures.forEach(function(u){h+='<img src="'+u+'" style="height:60px;margin:4px;border:1px solid #333;border-radius:4px" onerror="this.style.display=\'none\'"/> ';});h+='</p>';}
h+='</div>';});h+='</div>';}
if(t.plate_search){var plok=t.plate_search.status==='OK';
h+='<div class="test"><h3>'+(plok?'OK':'ERROR')+' TEST 5: PATENTE</h3>';
h+='<p>Patente: <span class="num">'+t.plate_search.plate+'</span></p>';
if(plok&&t.plate_search.result&&typeof t.plate_search.result==='object'){var v=t.plate_search.result;
h+='<p>Vehiculo: <span class="num">'+(v.brand||'?')+' '+(v.model||'?')+' '+(v.version||'')+' ('+(v.year||'?')+')</span></p>';}
else h+='<p class="'+(plok?'warn':'fail')+'">'+(t.plate_search.message||JSON.stringify(t.plate_search.result))+'</p>';
h+='</div>';}
if(data.error)h+='<div class="test"><h3 class="fail">ERROR</h3><pre>'+data.error+'</pre></div>';
h+='<div class="test"><h3>JSON COMPLETO</h3><pre>'+JSON.stringify(data,null,2)+'</pre></div>';
document.getElementById('out').innerHTML=h;}
</script>
</body>
</html>
