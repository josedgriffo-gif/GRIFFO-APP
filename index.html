<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>GRIFFO APP</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--p:#00549F;--a:#00ADD0;--d:#005B82;--bg:#F0F4F8;--c:#FFF;--t:#0D1B2A;--m:#4A6175}
body{font-family:'Montserrat',sans-serif;background:var(--bg);min-height:100vh;display:flex;justify-content:center}
.app{max-width:480px;width:100%;min-height:100vh;position:relative;background:var(--bg)}
.scr{display:none;flex-direction:column;min-height:100vh}.scr.on{display:flex}
.hero{background:linear-gradient(165deg,var(--d) 0%,var(--p) 55%,#003A75 100%);padding:40px 24px 48px;position:relative;border-radius:0 0 32px 32px;box-shadow:0 8px 32px rgba(0,59,117,.25);overflow:hidden}
.hero-c{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center}
.logo{width:200px;height:auto}.logo-s{width:120px;height:auto}
.slo{margin-top:6px;font-size:12.5px;font-weight:700;letter-spacing:4.5px;color:var(--a);text-transform:uppercase}
.slo-s{font-size:9px;letter-spacing:3px;margin-top:4px;font-weight:700;color:var(--a);text-transform:uppercase}
.sub{margin-top:16px;font-size:14.5px;font-weight:500;color:rgba(255,255,255,.78);text-align:center}
.ov{position:absolute;border-radius:50%;pointer-events:none}
.o1{left:-8%;top:-30%;width:840px;height:560px;border:2px solid rgba(255,255,255,.12);background:rgba(255,255,255,.07);transform:rotate(-25deg)}
.o2{left:70%;top:-15%;width:700px;height:460px;border:2px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);transform:rotate(15deg)}
.hdr{background:linear-gradient(165deg,var(--d) 0%,var(--p) 55%,#003A75 100%);padding:20px 20px 24px;position:relative;border-radius:0 0 24px 24px;overflow:hidden;display:flex;align-items:center;gap:12px}
.bk{background:rgba(255,255,255,.15);border:none;border-radius:10px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;z-index:1;flex-shrink:0}
.bk svg{stroke:#fff;width:20px;height:20px;fill:none;stroke-width:2;stroke-linecap:round}
.hdr-info{position:relative;z-index:1}
.ow{padding:26px 20px 20px;flex:1}
.ol{font-size:11.5px;font-weight:700;letter-spacing:2px;color:var(--m);text-transform:uppercase;margin-bottom:14px}
.opts{display:flex;flex-direction:column;gap:11px}
.ob{display:flex;align-items:center;gap:14px;padding:16px 18px;background:var(--c);border:1px solid rgba(0,84,159,.08);border-radius:14px;cursor:pointer;width:100%;text-align:left;box-shadow:0 2px 12px rgba(0,84,159,.08);transition:all .25s;font-family:inherit;border:none}
.ob:hover{transform:translateY(-1px);box-shadow:0 4px 20px rgba(0,84,159,.15)}
.oi{width:48px;height:48px;border-radius:12px;background:rgba(0,84,159,.05);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.ot{font-size:15px;font-weight:700;color:var(--t)}
.od{font-size:12.5px;color:var(--m);margin-top:2px}
.sa{padding:24px 20px}
.st{font-size:18px;font-weight:800;color:var(--t);margin-bottom:16px}
.fld{margin-bottom:14px}
.fld label{display:block;font-size:11px;font-weight:700;color:var(--m);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.fld input,.fld select{width:100%;padding:14px 16px;border:1.5px solid rgba(0,84,159,.12);border-radius:12px;font-size:15px;font-family:inherit;color:var(--t);background:var(--c);outline:none}
.fld input:focus,.fld select:focus{border-color:var(--p);box-shadow:0 0 0 3px rgba(0,84,159,.1)}
.sb{width:100%;padding:16px;border:none;border-radius:14px;font-size:16px;font-weight:700;font-family:inherit;cursor:pointer;background:linear-gradient(135deg,var(--p),var(--d));color:#fff;box-shadow:0 4px 20px rgba(0,84,159,.25);margin-top:8px}
.sb:disabled{opacity:.5}
.res{padding:0 20px 20px}
.rc{background:var(--c);border-radius:14px;padding:16px;margin-bottom:12px;box-shadow:0 2px 12px rgba(0,84,159,.08);cursor:pointer;transition:all .2s}
.rc:hover{box-shadow:0 4px 20px rgba(0,84,159,.15)}
.r-code{font-size:18px;font-weight:800;color:var(--p)}
.r-desc{font-size:13px;color:var(--t);margin-top:4px}
.r-cat{font-size:11px;color:var(--m);margin-top:2px}
.r-imgs{display:flex;gap:8px;margin-top:10px;overflow-x:auto}
.r-imgs img{height:70px;border-radius:8px;border:1px solid #eee}
.r-vehi{font-size:11px;color:var(--m);margin-top:8px}
.r-more{font-size:11px;color:var(--a);font-weight:700;margin-top:8px}
.nr{text-align:center;padding:40px 20px;color:var(--m);font-size:14px}
.ld{text-align:center;padding:40px 20px;color:var(--p);font-weight:600}
.vi{background:var(--c);border-radius:14px;padding:16px;margin:0 20px 16px;box-shadow:0 2px 12px rgba(0,84,159,.08)}
.vi h3{font-size:16px;color:var(--p);font-weight:800}
.vi p{font-size:13px;color:var(--m);margin-top:4px}
.cnt{font-size:13px;color:var(--m);padding:0 20px 12px}
.ft{padding:14px 24px 26px;text-align:center;margin-top:auto}
.sd{display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:6px}
.sd-d{width:7px;height:7px;border-radius:50%;background:#22C55E;animation:pu 2s infinite}
.sd-t{font-size:11.5px;font-weight:600;color:#22C55E}
.ft-t{font-size:10.5px;color:var(--m);font-weight:500}
.bl{height:4px;background:linear-gradient(90deg,var(--d),var(--p),var(--a))}
.d-gallery{display:flex;gap:10px;overflow-x:auto;padding:16px 20px;scroll-snap-type:x mandatory}
.d-gallery img{height:180px;border-radius:12px;border:1px solid #eee;scroll-snap-align:start;background:#f5f5f5}
.d-body{padding:0 20px 20px}
.d-code{font-size:24px;font-weight:900;color:var(--p)}
.d-prod{font-size:15px;font-weight:700;color:var(--t);margin-top:4px}
.d-desc{font-size:13px;color:var(--m);margin-top:2px}
.d-cat{display:inline-block;font-size:10px;font-weight:700;color:var(--a);background:rgba(0,173,208,.1);padding:4px 10px;border-radius:6px;margin-top:8px;text-transform:uppercase;letter-spacing:.5px}
.d-sec{margin-top:20px}
.d-sec-t{font-size:12px;font-weight:700;color:var(--m);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid rgba(0,84,159,.08)}
.d-attr{display:flex;flex-wrap:wrap;gap:8px}
.d-attr-i{background:rgba(0,84,159,.04);border-radius:8px;padding:8px 12px;flex:1;min-width:45%}
.d-attr-n{font-size:10px;color:var(--m);text-transform:uppercase}
.d-attr-v{font-size:14px;font-weight:700;color:var(--t);margin-top:2px}
.d-comp{background:rgba(0,84,159,.04);border-radius:8px;padding:10px 12px;margin-bottom:6px}
.d-comp-c{font-size:13px;font-weight:700;color:var(--p)}
.d-comp-p{font-size:11px;color:var(--m);margin-top:1px}
.d-vg{margin-bottom:10px}
.d-vg-brand{font-size:13px;font-weight:700;color:var(--t);margin-bottom:4px}
.d-vg-item{font-size:11.5px;color:var(--m);padding:3px 0;border-bottom:1px solid rgba(0,84,159,.04)}
.d-acts{display:flex;gap:10px;margin-top:20px;position:sticky;bottom:0;background:var(--bg);padding:16px 0 8px}
.bw2{flex:1;padding:14px;border:none;border-radius:12px;font-size:14px;font-weight:700;font-family:inherit;cursor:pointer;background:#25D366;color:#fff;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 16px rgba(37,211,102,.3)}
.bm2{flex:1;padding:14px;border:none;border-radius:12px;font-size:14px;font-weight:700;font-family:inherit;cursor:pointer;background:#FFE600;color:#333;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 16px rgba(255,230,0,.3)}
@keyframes pu{0%,100%{opacity:1}50%{opacity:.5}}

/* === AUTH STYLES === */
.auth-card{background:var(--c);border-radius:16px;padding:24px;margin:24px 20px;box-shadow:0 2px 16px rgba(0,84,159,.1)}
.auth-title{font-size:20px;font-weight:800;color:var(--t);margin-bottom:20px;text-align:center}
.auth-sep{display:flex;align-items:center;gap:12px;margin:18px 0;font-size:11px;color:var(--m);font-weight:700;text-transform:uppercase;letter-spacing:1px}
.auth-sep:before,.auth-sep:after{content:'';flex:1;height:1px;background:rgba(0,84,159,.12)}
.gb{width:100%;padding:14px;border:1.5px solid rgba(0,84,159,.12);border-radius:12px;font-size:15px;font-weight:600;font-family:inherit;cursor:pointer;background:var(--c);color:var(--t);display:flex;align-items:center;justify-content:center;gap:10px;transition:all .2s}
.gb:hover{background:rgba(0,84,159,.03);box-shadow:0 2px 12px rgba(0,84,159,.1)}
.auth-link{text-align:center;margin-top:18px;font-size:13px;color:var(--m)}
.auth-link a{color:var(--p);font-weight:700;text-decoration:none;cursor:pointer}
.auth-err{color:#E53E3E;font-size:12px;font-weight:600;text-align:center;margin-top:8px;display:none}
.usr-bar{display:none;align-items:center;justify-content:space-between;padding:10px 20px;margin:0 20px 4px;background:var(--c);border-radius:12px;box-shadow:0 2px 8px rgba(0,84,159,.06)}
.usr-bar.on{display:flex}
.usr-name{font-size:12px;font-weight:600;color:var(--p);display:flex;align-items:center;gap:6px}
.usr-name svg{width:16px;height:16px;stroke:var(--p);fill:none;stroke-width:2}
.usr-out{font-size:11px;color:var(--m);cursor:pointer;font-weight:600;background:none;border:none;font-family:inherit;text-decoration:underline}
</style>
</head>
<body>
<div class="app">

<!-- ===== HOME ===== -->
<div id="s-home" class="scr on">
<div class="hero"><div class="ov o1"></div><div class="ov o2"></div>
<div class="hero-c">
<img class="logo" id="logo-main" alt="Griffo">
<div class="slo">Impulsamos Soluciones</div>
<div class="sub">Buscador de productos</div>
</div></div>
<div id="usr-home" class="usr-bar"><span class="usr-name"><svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M20 21a8 8 0 10-16 0"/></svg><span id="usr-display"></span></span><button class="usr-out" onclick="logout()">Salir</button></div>
<div class="ow"><div class="ol">&#191;C&#243;mo quer&#233;s buscar?</div>
<div class="opts">
<button class="ob" onclick="go('plate')"><div class="oi"><svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#00549F" stroke-width="1.6"><rect x="2" y="6" width="20" height="12" rx="3"/><text x="12" y="15" text-anchor="middle" font-size="6.5" font-weight="700" fill="#00549F" stroke="none" font-family="monospace">AB 123</text></svg></div><div><div class="ot">Por Patente</div><div class="od">Ingres&#225; la patente del veh&#237;culo</div></div></button>
<button class="ob" onclick="go('vehicle')"><div class="oi"><svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#00549F" stroke-width="1.6"><path d="M5 17h14M6 17l1.5-5.5h9L18 17"/><path d="M7.5 11.5L8.5 8h7l1 3.5"/><circle cx="8" cy="17" r="1.5" fill="#00549F" stroke="none"/><circle cx="16" cy="17" r="1.5" fill="#00549F" stroke="none"/></svg></div><div><div class="ot">Por Veh&#237;culo</div><div class="od">Marca &#8594; Modelo &#8594; A&#241;o</div></div></button>
<button class="ob" onclick="go('code')"><div class="oi"><svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#00549F" stroke-width="1.6"><rect x="3" y="4" width="18" height="16" rx="2"/><line x1="7" y1="9" x2="17" y2="9"/><line x1="7" y1="13" x2="13" y2="13"/></svg></div><div><div class="ot">Por C&#243;digo</div><div class="od">C&#243;digo GRIFFO del producto</div></div></button>
<button class="ob" onclick="go('keyword')"><div class="oi"><svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#00549F" stroke-width="1.6"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div><div><div class="ot">Por Palabra</div><div class="od">B&#250;squeda libre</div></div></button>
</div></div>
<div class="ft"><div class="sd"><div class="sd-d"></div><span class="sd-t">Cat&#225;logo conectado</span></div><div class="ft-t">GRIFFO SRL &#183; Industria Argentina &#183; griffo.com.ar</div></div>
<div class="bl"></div>
</div>

<!-- ===== LOGIN ===== -->
<div id="s-login" class="scr">
<div class="hero"><div class="ov o1"></div><div class="ov o2"></div>
<div class="hero-c">
<img class="logo" id="logo-login" alt="Griffo">
<div class="slo">Impulsamos Soluciones</div>
<div class="sub">Ingres&#225; a tu cuenta</div>
</div></div>
<div class="auth-card">
<div class="auth-title">Iniciar Sesi&#243;n</div>
<button class="gb" onclick="googleLogin()"><svg width="20" height="20" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>Continuar con Google</button>
<div class="auth-sep">o con email</div>
<div class="fld"><label>Email</label><input id="login-email" type="email" placeholder="tu@email.com"></div>
<div class="fld"><label>Contrase&#241;a</label><input id="login-pass" type="password" placeholder="Tu contrase&#241;a" onkeydown="if(event.key==='Enter')emailLogin()"></div>
<div id="login-err" class="auth-err"></div>
<button class="sb" onclick="emailLogin()">Ingresar</button>
<div class="auth-link">&#191;No ten&#233;s cuenta? <a onclick="go('register')">Registrate</a></div>
</div>
<div style="text-align:center;margin-top:4px"><a onclick="go('home')" style="font-size:12px;color:var(--m);cursor:pointer;font-weight:600">&#8592; Volver al inicio</a></div>
<div class="ft"><div class="ft-t">GRIFFO SRL &#183; griffo.com.ar</div></div>
<div class="bl"></div>
</div>

<!-- ===== REGISTRO ===== -->
<div id="s-register" class="scr">
<div class="hero"><div class="ov o1"></div><div class="ov o2"></div>
<div class="hero-c">
<img class="logo" id="logo-reg" alt="Griffo">
<div class="slo">Impulsamos Soluciones</div>
<div class="sub">Cre&#225; tu cuenta</div>
</div></div>
<div class="auth-card">
<div class="auth-title">Registro</div>
<button class="gb" onclick="googleLogin()"><svg width="20" height="20" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>Continuar con Google</button>
<div class="auth-sep">o con email</div>
<div class="fld"><label>Nombre</label><input id="reg-name" placeholder="Tu nombre"></div>
<div class="fld"><label>Email</label><input id="reg-email" type="email" placeholder="tu@email.com"></div>
<div class="fld"><label>Contrase&#241;a</label><input id="reg-pass" type="password" placeholder="M&#237;nimo 6 caracteres" onkeydown="if(event.key==='Enter')emailRegister()"></div>
<div id="reg-err" class="auth-err"></div>
<button class="sb" onclick="emailRegister()">Crear Cuenta</button>
<div class="auth-link">&#191;Ya ten&#233;s cuenta? <a onclick="go('login')">Ingres&#225;</a></div>
</div>
<div style="text-align:center;margin-top:4px"><a onclick="go('home')" style="font-size:12px;color:var(--m);cursor:pointer;font-weight:600">&#8592; Volver al inicio</a></div>
<div class="ft"><div class="ft-t">GRIFFO SRL &#183; griffo.com.ar</div></div>
<div class="bl"></div>
</div>

<!-- ===== BÚSQUEDA POR PATENTE ===== -->
<div id="s-plate" class="scr">
<div class="hdr"><div class="ov o1"></div><div class="ov o2"></div><button class="bk" onclick="go('home')"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button><div class="hdr-info"><img class="logo-s" id="logo-plate" alt="Griffo"><div class="slo-s">Impulsamos Soluciones</div></div></div>
<div class="sa"><div class="st">Buscar por Patente</div><div class="fld"><label>Patente del veh&#237;culo</label><input id="inp-plate" placeholder="Ej: AC923HI" maxlength="10" style="text-transform:uppercase" onkeydown="if(event.key==='Enter')searchPlate()"></div><button class="sb" onclick="searchPlate()">Buscar</button></div>
<div id="plate-vi"></div><div id="plate-res" class="res"></div>
<div class="ft"><div class="ft-t">GRIFFO SRL &#183; griffo.com.ar</div></div><div class="bl"></div>
</div>

<!-- ===== BÚSQUEDA POR VEHÍCULO ===== -->
<div id="s-vehicle" class="scr">
<div class="hdr"><div class="ov o1"></div><div class="ov o2"></div><button class="bk" onclick="go('home')"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button><div class="hdr-info"><img class="logo-s" id="logo-vehi" alt="Griffo"><div class="slo-s">Impulsamos Soluciones</div></div></div>
<div class="sa"><div class="st">Buscar por Veh&#237;culo</div>
<div class="fld"><label>Marca</label><select id="sel-brand" onchange="onBrand()"><option value="">Cargando marcas...</option></select></div>
<div class="fld"><label>Modelo</label><select id="sel-model" onchange="onModel()" disabled><option value="">Primero eleg&#237; marca</option></select></div>
<div class="fld"><label>A&#241;o</label><select id="sel-year" disabled><option value="">Primero eleg&#237; modelo</option></select></div>
<button class="sb" onclick="searchVehicle()">Buscar</button></div>
<div id="vehi-res" class="res"></div>
<div class="ft"><div class="ft-t">GRIFFO SRL &#183; griffo.com.ar</div></div><div class="bl"></div>
</div>

<!-- ===== BÚSQUEDA POR CÓDIGO ===== -->
<div id="s-code" class="scr">
<div class="hdr"><div class="ov o1"></div><div class="ov o2"></div><button class="bk" onclick="go('home')"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button><div class="hdr-info"><img class="logo-s" id="logo-code" alt="Griffo"><div class="slo-s">Impulsamos Soluciones</div></div></div>
<div class="sa"><div class="st">Buscar por C&#243;digo</div><div class="fld"><label>C&#243;digo del producto</label><input id="inp-code" placeholder="Ej: 253-32" onkeydown="if(event.key==='Enter')searchCode()"></div><button class="sb" onclick="searchCode()">Buscar</button></div>
<div id="code-res" class="res"></div>
<div class="ft"><div class="ft-t">GRIFFO SRL &#183; griffo.com.ar</div></div><div class="bl"></div>
</div>

<!-- ===== BÚSQUEDA POR PALABRA ===== -->
<div id="s-keyword" class="scr">
<div class="hdr"><div class="ov o1"></div><div class="ov o2"></div><button class="bk" onclick="go('home')"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button><div class="hdr-info"><img class="logo-s" id="logo-kw" alt="Griffo"><div class="slo-s">Impulsamos Soluciones</div></div></div>
<div class="sa"><div class="st">B&#250;squeda Libre</div><div class="fld"><label>Palabra clave</label><input id="inp-kw" placeholder="Ej: amortiguador, fuelle, direccion..." onkeydown="if(event.key==='Enter')searchKw()"></div><button class="sb" onclick="searchKw()">Buscar</button></div>
<div id="kw-res" class="res"></div>
<div class="ft"><div class="ft-t">GRIFFO SRL &#183; griffo.com.ar</div></div><div class="bl"></div>
</div>

<!-- ===== DETALLE PRODUCTO ===== -->
<div id="s-detail" class="scr">
<div class="hdr"><div class="ov o1"></div><div class="ov o2"></div><button class="bk" onclick="goBack()"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button><div class="hdr-info"><img class="logo-s" id="logo-det" alt="Griffo"><div class="slo-s">Impulsamos Soluciones</div></div></div>
<div id="det-gallery" class="d-gallery"></div>
<div id="det-body" class="d-body"></div>
<div class="ft"><div class="ft-t">GRIFFO SRL &#183; griffo.com.ar</div></div><div class="bl"></div>
</div>

</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
/* === VARIABLES EXISTENTES (sin cambios) === */
var P=null,RP=[],BS='',LG='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';

/* === VARIABLES AUTH (nuevas) === */
var pendingGo=null,currentUser=null;

/* === LOGOS === */
function setLogos(){var s='data:image/png;base64,'+LG;['logo-main','logo-plate','logo-vehi','logo-code','logo-kw','logo-det','logo-login','logo-reg'].forEach(function(id){var el=document.getElementById(id);if(el)el.src=s;});}
setLogos();

/* === FIREBASE INIT === */
firebase.initializeApp({
apiKey:"AIzaSyBOvhsx73SX0WJDdz9fP0z9pcA-svsiVD8",
authDomain:"griffo-app.firebaseapp.com",
projectId:"griffo-app",
appId:"1:710468527470:web:f673ee218ee383b763cd7f"
});

var db=firebase.firestore();

firebase.auth().onAuthStateChanged(function(user){
currentUser=user;
var bar=document.getElementById('usr-home');
var name=document.getElementById('usr-display');
if(user){
bar.classList.add('on');
name.textContent=user.displayName||user.email;
if(pendingGo){var dest=pendingGo;pendingGo=null;go(dest);}
}else{
bar.classList.remove('on');
name.textContent='';
}
});

/* === NAVEGACIÓN (modificado: agrega login diferido) === */
function go(s){
if(['plate','vehicle','code','keyword'].indexOf(s)>=0&&!currentUser){pendingGo=s;s='login';}
document.querySelectorAll('.scr').forEach(function(e){e.classList.remove('on')});
document.getElementById('s-'+s).classList.add('on');
window.scrollTo(0,0);
if(s!=='home'&&s!=='detail'&&s!=='login'&&s!=='register'&&!P)loadP();
}

function goBack(){go(BS||'home');}

/* === FUNCIONES AUTH (nuevas) === */
function showErr(id,msg){var el=document.getElementById(id);el.textContent=msg;el.style.display='block';}
function hideErr(id){document.getElementById(id).style.display='none';}

async function emailLogin(){
var email=document.getElementById('login-email').value.trim();
var pass=document.getElementById('login-pass').value;
if(!email||!pass){showErr('login-err','Complet\u00e1 email y contrase\u00f1a');return;}
hideErr('login-err');
try{await firebase.auth().signInWithEmailAndPassword(email,pass);}
catch(e){
var msg='Error al ingresar';
if(e.code==='auth/user-not-found'||e.code==='auth/wrong-password'||e.code==='auth/invalid-credential')msg='Email o contrase\u00f1a incorrectos';
if(e.code==='auth/invalid-email')msg='Email inv\u00e1lido';
if(e.code==='auth/too-many-requests')msg='Demasiados intentos. Esper\u00e1 un momento';
showErr('login-err',msg);
}
}

async function emailRegister(){
var name=document.getElementById('reg-name').value.trim();
var email=document.getElementById('reg-email').value.trim();
var pass=document.getElementById('reg-pass').value;
if(!name){showErr('reg-err','Ingres\u00e1 tu nombre');return;}
if(!email){showErr('reg-err','Ingres\u00e1 tu email');return;}
if(pass.length<6){showErr('reg-err','La contrase\u00f1a debe tener al menos 6 caracteres');return;}
hideErr('reg-err');
try{
var cred=await firebase.auth().createUserWithEmailAndPassword(email,pass);
await cred.user.updateProfile({displayName:name});
currentUser=firebase.auth().currentUser;
var bar=document.getElementById('usr-home');
var disp=document.getElementById('usr-display');
bar.classList.add('on');disp.textContent=name;
if(pendingGo){var dest=pendingGo;pendingGo=null;go(dest);}else{go('home');}
}catch(e){
var msg='Error al registrar';
if(e.code==='auth/email-already-in-use')msg='Ese email ya est\u00e1 registrado';
if(e.code==='auth/invalid-email')msg='Email inv\u00e1lido';
if(e.code==='auth/weak-password')msg='Contrase\u00f1a muy d\u00e9bil';
showErr('reg-err',msg);
}
}

async function googleLogin(){
try{var provider=new firebase.auth.GoogleAuthProvider();await firebase.auth().signInWithPopup(provider);}
catch(e){if(e.code!=='auth/popup-closed-by-user')console.error('Google login error:',e);}
}

function logout(){firebase.auth().signOut();pendingGo=null;go('home');}

/* === ANALYTICS TRACKING === */
function track(event,data){
try{
data=data||{};
data.event=event;
data.timestamp=new Date().toISOString();
data.uid=currentUser?currentUser.uid:null;
data.userEmail=currentUser?currentUser.email:null;
data.userName=currentUser?currentUser.displayName:null;
db.collection('analytics').add(data);
}catch(e){console.error('Track error:',e);}
}

function trackWA(code,product){
var c=decodeURIComponent(code),pr=decodeURIComponent(product);
var msg='Hola! Vi en la app GRIFFO el producto '+c+' ('+pr+'). Tenes disponibilidad y precio?';
var url='https://wa.me/?text='+encodeURIComponent(msg);
track('whatsapp_click',{code:c,product:pr});
window.open(url,'_blank');
}

function trackML(code,product,link){
var c=decodeURIComponent(code),pr=decodeURIComponent(product),l=decodeURIComponent(link);
track('mercadolibre_click',{code:c,product:pr,link:l});
window.open(l,'_blank');
}

/* === PRODUCTOS Y BÚSQUEDAS (sin cambios) === */
async function loadP(){
try{var r=await fetch('/api/products');var d=await r.json();P=d.products;fillBrands();}
catch(e){console.error(e);}
}

function fillBrands(){
var ex={'AGRALE':1,'IVECO':1,'UNIVERSAL':1};
var br={};P.forEach(function(p){if(p.vehicles)p.vehicles.forEach(function(v){if(v.brand&&!ex[v.brand])br[v.brand]=1;});});
var s=document.getElementById('sel-brand');s.innerHTML='<option value="">Seleccion&#225; marca</option>';
Object.keys(br).sort().forEach(function(b){s.innerHTML+='<option value="'+b+'">'+b+'</option>';});
}

function onBrand(){
var b=document.getElementById('sel-brand').value;var ms={};
P.forEach(function(p){if(p.vehicles)p.vehicles.forEach(function(v){if(v.brand===b&&v.master_model)ms[v.master_model]=1;});});
var s=document.getElementById('sel-model');s.disabled=!b;s.innerHTML='<option value="">Seleccion&#225; modelo</option>';
Object.keys(ms).sort().forEach(function(m){s.innerHTML+='<option value="'+m+'">'+m+'</option>';});
document.getElementById('sel-year').disabled=true;document.getElementById('sel-year').innerHTML='<option value="">Primero eleg&#237; modelo</option>';
}

function onModel(){
var b=document.getElementById('sel-brand').value,m=document.getElementById('sel-model').value,ys={};
P.forEach(function(p){if(p.vehicles)p.vehicles.forEach(function(v){
if(v.brand===b&&v.master_model===m){for(var y=v.sold_from_year;y<=v.sold_until_year;y++)ys[y]=1;}
});});
var s=document.getElementById('sel-year');s.disabled=!m;s.innerHTML='<option value="">Seleccion&#225; a&#241;o (opcional)</option>';
Object.keys(ys).sort(function(a,b){return b-a}).forEach(function(y){s.innerHTML+='<option value="'+y+'">'+y+'</option>';});
}

async function searchPlate(){
var pl=document.getElementById('inp-plate').value.trim().toUpperCase();if(!pl)return;
document.getElementById('plate-vi').innerHTML='';document.getElementById('plate-res').innerHTML='<div class="ld">Buscando veh&#237;culo...</div>';
try{
var r=await fetch('/api/plate?plate='+encodeURIComponent(pl));var v=await r.json();
if(v.error){document.getElementById('plate-res').innerHTML='<div class="nr">No se encontr&#243; veh&#237;culo para esa patente</div>';return;}
document.getElementById('plate-vi').innerHTML='<div class="vi"><h3>'+(v.brand||'')+' '+(v.master_model||v.model||'')+'</h3><p>'+(v.version||'')+' ('+(v.sold_from_year||'')+')</p></div>';
if(!P){document.getElementById('plate-res').innerHTML='<div class="ld">Cargando cat&#225;logo...</div>';var pr=await fetch('/api/products');var pd=await pr.json();P=pd.products;fillBrands();}
var matches=P.filter(function(p){if(!p.vehicles)return false;return p.vehicles.some(function(pv){
if(pv.brand!==v.brand)return false;
if(v.master_model&&pv.master_model===v.master_model)return true;
if(v.model&&pv.model===v.model)return true;
return false;
});});
render('plate-res',matches,'plate');
track('search',{type:'plate',query:pl,brand:v.brand||'',model:v.master_model||v.model||'',results:matches.length});
}catch(e){document.getElementById('plate-res').innerHTML='<div class="nr">Error: '+e.message+'</div>';}
}

function searchVehicle(){
var b=document.getElementById('sel-brand').value,m=document.getElementById('sel-model').value,y=document.getElementById('sel-year').value;
if(!b){alert('Seleccion\u00e1 al menos una marca');return;}if(!P)return;
var matches=P.filter(function(p){if(!p.vehicles)return false;return p.vehicles.some(function(v){
if(v.brand!==b)return false;if(m&&v.master_model!==m)return false;
if(y){var yr=parseInt(y);if(yr<v.sold_from_year||yr>v.sold_until_year)return false;}
return true;
});});
render('vehi-res',matches,'vehicle');
track('search',{type:'vehicle',query:b+' '+m+(y?' '+y:''),brand:b,model:m,year:y,results:matches.length});
}

function searchCode(){
var c=document.getElementById('inp-code').value.trim();if(!c||!P)return;
var matches=P.filter(function(p){return p.code&&p.code.toLowerCase().indexOf(c.toLowerCase())>=0;});
render('code-res',matches,'code');
track('search',{type:'code',query:c,results:matches.length});
}

function searchKw(){
var k=document.getElementById('inp-kw').value.trim().toLowerCase();if(!k||!P)return;
var matches=P.filter(function(p){
var t=((p.code||'')+' '+(p.description||'')+' '+(p.product||'')+' '+(p.category||'')).toLowerCase();
return t.indexOf(k)>=0;
});
render('kw-res',matches,'keyword');
track('search',{type:'keyword',query:k,results:matches.length});
}

function render(id,items,from){
var el=document.getElementById(id);RP=items;BS=from||'home';
if(!items||items.length===0){el.innerHTML='<div class="nr">No se encontraron productos</div>';return;}
var h='<div class="cnt">'+items.length+' producto'+(items.length>1?'s':'')+' encontrado'+(items.length>1?'s':'')+'</div>';
items.forEach(function(p,i){
h+='<div class="rc" onclick="showDetail('+i+')">';
h+='<div class="r-code">'+(p.code||'')+'</div>';
h+='<div class="r-desc">'+(p.product||'')+' - '+(p.description||'')+'</div>';
h+='<div class="r-cat">'+(p.category||'')+'</div>';
if(p.pictures&&p.pictures.length>0){h+='<div class="r-imgs">';p.pictures.slice(0,2).forEach(function(pic){var u=pic.image_url||pic.url||'';if(u)h+='<img src="'+u+'" onerror="this.style.display=\'none\'">';});h+='</div>';}
if(p.vehicles&&p.vehicles.length>0)h+='<div class="r-vehi">'+p.vehicles.length+' veh\u00edculo'+(p.vehicles.length>1?'s':'')+' compatible'+(p.vehicles.length>1?'s':'')+'</div>';
h+='<div class="r-more">Ver detalle &#8594;</div>';
h+='</div>';
});
el.innerHTML=h;
}

function showDetail(i){
var p=RP[i];if(!p)return;
track('product_view',{code:p.code||'',product:p.product||'',category:p.category||''});
var gal=document.getElementById('det-gallery');
var body=document.getElementById('det-body');
var gh='';
if(p.pictures&&p.pictures.length>0){p.pictures.forEach(function(pic){var u=pic.image_url||pic.url||'';if(u)gh+='<img src="'+u+'" onerror="this.style.display=\'none\'">';});}
gal.innerHTML=gh;
var h='<div class="d-code">'+(p.code||'')+'</div>';
h+='<div class="d-prod">'+(p.product||'')+'</div>';
h+='<div class="d-desc">'+(p.description||'')+'</div>';
h+='<span class="d-cat">'+(p.category||'')+'</span>';
if(p.attributes&&p.attributes.length>0){
h+='<div class="d-sec"><div class="d-sec-t">Medidas / Atributos</div><div class="d-attr">';
p.attributes.forEach(function(a){h+='<div class="d-attr-i"><div class="d-attr-n">'+(a.name||'')+'</div><div class="d-attr-v">'+(a.value||'')+' '+(a.unit||'')+'</div></div>';});
h+='</div></div>';
}
if(p.components&&p.components.length>0){
h+='<div class="d-sec"><div class="d-sec-t">Contenido del Kit</div>';
p.components.forEach(function(c){h+='<div class="d-comp"><div class="d-comp-c">'+(c.code||'')+'</div><div class="d-comp-p">'+(c.product||'')+'</div></div>';});
h+='</div>';
}
if(p.vehicles&&p.vehicles.length>0){
var vg={};p.vehicles.forEach(function(v){var b=v.brand||'Otros';if(!vg[b])vg[b]=[];vg[b].push(v);});
h+='<div class="d-sec"><div class="d-sec-t">Veh\u00edculos Compatibles ('+p.vehicles.length+')</div>';
Object.keys(vg).sort().forEach(function(b){
h+='<div class="d-vg"><div class="d-vg-brand">'+b+'</div>';
vg[b].forEach(function(v){h+='<div class="d-vg-item">'+(v.master_model||v.model||'')+' '+(v.version||'')+' ('+v.sold_from_year+'-'+v.sold_until_year+')</div>';});
h+='</div>';
});
h+='</div>';
}
var msg='Hola! Vi en la app GRIFFO el producto '+(p.code||'')+' ('+(p.product||'')+'). Tenes disponibilidad y precio?';
h+='<div class="d-acts">';
h+='<button class="bw2" onclick="trackWA(\''+encodeURIComponent(p.code||'')+'\',\''+encodeURIComponent(p.product||'')+'\')"><svg width="18" height="18" viewBox="0 0 24 24" fill="#fff"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.625.846 5.059 2.284 7.034L.789 23.492l4.624-1.472A11.932 11.932 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 21.818c-2.168 0-4.183-.655-5.863-1.776l-.42-.282-2.751.876.877-2.672-.294-.44A9.787 9.787 0 012.182 12 9.818 9.818 0 0112 2.182 9.818 9.818 0 0121.818 12 9.818 9.818 0 0112 21.818z"/></svg>WhatsApp</button>';
var meli='';if(p.links&&p.links.length>0)p.links.forEach(function(l){if(l.url||l.link)meli=l.url||l.link;});
if(meli)h+='<button class="bm2" onclick="trackML(\''+encodeURIComponent(p.code||'')+'\',\''+encodeURIComponent(p.product||'')+'\',\''+encodeURIComponent(meli)+'\')">MercadoLibre</button>';
h+='</div>';
body.innerHTML=h;
go('detail');
}
</script>
</body>
</html>
